<!DOCTYPE html>
<html lang="en" class="theme-1">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>world-situation</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  :root {
    --bg-gradient: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FECA57);
    --bg-size: 400% 400%;
    --accent: #FF6B6B;
    --accent-foreground: #ffffff;
    --widget-bg: rgba(255, 255, 255, 0.95);
    --text-color: #333;
    --muted-text: #666;
    --font-main: "Inter", sans-serif;
    --font-mono: "Roboto Mono", monospace;
    --widget-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --border-color: rgba(0, 0, 0, 0.05);
  }
  .theme-0 { /* Serene Dawn */
    --bg-gradient: linear-gradient(135deg, #fce38a, #f38181);
    --accent: #f38181;
    --accent-foreground: #2d1a1a;
    --widget-bg: rgba(255, 255, 255, 0.85);
    --text-color: #3a3a3a;
    --muted-text: #5f5f5f;
    --border-color: rgba(0, 0, 0, 0.05);
  }
  .theme-1 { /* Midnight Matrix */
    --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    --accent: #7CFC00;
    --accent-foreground: #0b1924;
    --widget-bg: rgba(10, 25, 40, 0.8);
    --text-color: #e8f6f5;
    --muted-text: #a0bdba;
    --widget-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    --border-color: rgba(255, 255, 255, 0.1);
  }
  .theme-2 { /* Retro Terminal */
    --bg-gradient: linear-gradient(135deg, #0b1b0b, #183018);
    --accent: #7CFC00;
    --accent-foreground: #0b0b0b;
    --widget-bg: rgba(10, 10, 10, 0.9);
    --text-color: #BFFFBF;
    --muted-text: #9ad99a;
    --font-main: "Roboto Mono", monospace;
    --font-mono: "Roboto Mono", monospace;
    --widget-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
    --border-color: rgba(124, 252, 0, 0.2);
  }
  .theme-3 { /* Sahara Sunset */
    --bg-gradient: linear-gradient(135deg, #FFD194, #D1913C, #F6D365);
    --accent: #D1913C;
    --accent-foreground: #ffffff;
    --widget-bg: rgba(255, 255, 255, 0.9);
    --text-color: #4d3e2f;
    --muted-text: #7d6a55;
    --border-color: rgba(0, 0, 0, 0.08);
  }
  .theme-4 { /* Synthwave Grid */
    --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    --accent: #FF00FF;
    --accent-foreground: #ffffff;
    --widget-bg: rgba(20, 20, 20, 0.85);
    --text-color: #ffffff;
    --muted-text: #d0d0d0;
    --widget-shadow: 0 12px 40px rgba(255, 0, 255, 0.1);
    --border-color: rgba(255, 0, 255, 0.2);
  }
  html {
    scroll-behavior: smooth;
  }
  body {
    font-family: var(--font-main);
    background: var(--bg-gradient);
    background-size: var(--bg-size);
    animation: gradientShift 15s ease infinite;
    color: var(--text-color);
    transition: background 0.8s ease, color 0.6s ease;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .widget {
    background: var(--widget-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    box-shadow: var(--widget-shadow);
    transition: all 0.3s ease;
  }
  .widget:hover {
    transform: translateY(-6px) scale(1.01);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.15);
  }
  .sponsor-button {
    --hover-brightness: 1.05;
    background-color: var(--accent);
    color: var(--accent-foreground);
    box-shadow: var(--widget-shadow);
  }
  .sponsor-button:hover {
    filter: brightness(var(--hover-brightness));
  }
  .news-feed::-webkit-scrollbar { width: 6px; }
  .news-feed::-webkit-scrollbar-track { background: transparent; }
  .news-feed::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
  .skeleton {
    opacity: 0.7;
    animation: skeleton-loading 1s linear infinite alternate;
  }
  @keyframes skeleton-loading {
    0% { background-color: rgba(128, 128, 128, 0.1); }
    100% { background-color: rgba(128, 128, 128, 0.2); }
  }
  .custom-notification {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    border-radius: 8px;
    background-color: var(--accent);
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: bottom 0.5s ease-in-out;
    z-index: 10000;
    font-weight: 700;
  }
  .custom-notification.show {
    bottom: 20px;
  }
  #newsModal {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  #newsModal.active {
    display: flex;
  }
  #newsModal .modal-content {
    background: var(--widget-bg);
    color: var(--text-color);
    max-width: 640px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--widget-shadow);
    position: relative;
    font-family: var(--font-main);
  }
  #newsModal button.close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    color: var(--muted-text);
    font-size: 1.5rem;
    cursor: pointer;
    font-weight: 700;
    transition: color 0.2s ease;
  }
  #newsModal button.close-btn:hover {
    color: var(--accent);
  }
  #newsModal h2 {
    margin-bottom: 0.5rem;
    font-weight: 900;
  }
  #newsModal p.meta {
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: var(--muted-text);
  }
  #newsModal .description {
    line-height: 1.5;
    font-size: 1rem;
  }
  #newsModal a.full-link {
    display: inline-block;
    margin-top: 1rem;
    color: var(--accent);
    font-weight: 700;
    text-decoration: underline;
  }
</style>
</head>
<body class="min-h-screen overflow-x-hidden">
<div class="container mx-auto p-4 md:p-6">
  <!-- Header -->
  <header class="text-center mb-6">
    <h1 class="text-4xl md:text-5xl font-black mb-2" style="color: var(--text-color); text-shadow: 2px 2px 6px rgba(0,0,0,0.1);">
      üåç World Situation
    </h1>
    <p class="text-lg" style="color: var(--muted-text);">Things Are Getting Weirder</p>
    <div class="flex justify-center mt-4">
      <a id="sponsorLink" href="https://github.com/sponsors/Varun-SV" target="_blank" rel="noopener noreferrer" class="sponsor-button inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold" title="Sponsor this project on GitHub">
        <svg viewBox="0 0 16 16" width="20" height="20" fill="currentColor" role="img" aria-label="GitHub Sponsors heart icon" focusable="false">
          <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01z"></path>
        </svg>
        <span>Sponsor this project</span>
      </a>
    </div>
  </header>
  <!-- Main Dashboard Grid -->
  <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- News Feed Widget (Larger) -->
    <section class="widget rounded-2xl p-4 md:p-6 lg:col-span-2">
      <h2 class="text-xl font-bold mb-4 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        World News Feed
      </h2>
      <div class="flex items-center gap-2 mb-3 text-sm" style="color: var(--muted-text);">
        <div id="newsStatusIndicator" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
        <span id="newsStatusText">Initializing feeds...</span>
      </div>
      <div id="newsFeed" class="news-feed h-96 overflow-y-auto pr-2 space-y-3">
        <!-- Loading Skeleton -->
        <div class="space-y-3">
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
          <div class="h-16 rounded-lg skeleton"></div>
        </div>
      </div>
    </section>
    <!-- Local News Widget -->
    <section class="widget rounded-2xl p-4 md:p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z" /><circle cx="12" cy="10" r="3" /></svg>
        Local News
      </h2>
      <div id="localNewsFeed" class="news-feed h-96 overflow-y-auto pr-2 space-y-3">
        <p class="text-sm" style="color: var(--muted-text);">Awaiting location access to fetch local headlines...</p>
      </div>
    </section>
    <!-- Local Weather Widget -->
    <section class="widget rounded-2xl p-4 md:p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        Local Weather
      </h2>
      <div id="weatherData" class="space-y-4">
        <p class="text-sm" style="color: var(--muted-text);">Awaiting location access...</p>
      </div>
    </section>
    <!-- Global Markets Widget -->
    <section class="widget rounded-2xl p-4 md:p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        Global Markets
      </h2>
      <div id="marketData" class="space-y-3">
        <!-- Market data -->
      </div>
    </section>
    <!-- Local Intel & Global Status Widget -->
    <section class="widget rounded-2xl p-4 md:p-6">
      <h2 class="text-xl font-bold mb-4">Intel Briefing</h2>
      <div id="localIntel" class="space-y-3 mb-4 pb-4" style="border-bottom: 1px solid var(--border-color);">
        <h3 class="font-bold text-sm uppercase tracking-wider" style="color: var(--muted-text);">Local Intel</h3>
        <p class="text-sm" style="color: var(--muted-text);">Awaiting location access...</p>
      </div>
      <div class="space-y-3">
        <h3 class="font-bold text-sm uppercase tracking-wider" style="color: var(--muted-text);">Global Status</h3>
        <div class="flex justify-between items-center">
          <span class="font-semibold">Chaos Level:</span>
          <span id="chaosLevel" class="font-bold py-1 px-3 rounded-full text-sm" style="background-color: var(--accent); color: white;">Calculating...</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="font-semibold">AI Consciousness:</span>
          <span class="font-bold" style="color: var(--accent);">Probably Fine...</span>
        </div>
      </div>
    </section>
    <!-- Settings & About Widget -->
    <section class="widget rounded-2xl p-4 md:p-6 lg:col-span-3">
      <h2 class="text-xl font-bold mb-4">Settings & About</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <p class="text-sm mb-4" style="color: var(--muted-text);">This dashboard provides a real-time, slightly satirical glimpse into the state of the world. Data is aggregated from public RSS feeds.</p>
          <div class="text-xs" style="color: var(--muted-text);">
            Last updated: <span id="lastUpdate">Never</span>
          </div>
          <div class="mt-4 p-3 rounded-lg border" style="border-color: var(--border-color);">
            <p class="text-sm font-bold">Ethical Spotlight</p>
            <p class="text-xs" style="color: var(--muted-text);">Positive-impact initiatives can sponsor a message here. If it helps the world, we will gladly showcase it.</p>
          </div>
        </div>
        <div>
          <h3 class="font-bold mb-2">Change Theme</h3>
          <div id="themeSwitcher" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>
  </main>
</div>
<div id="customNotification" class="custom-notification"></div>

<!-- News Popup Modal -->
<div id="newsModal" aria-hidden="true">
  <div class="modal-content">
    <button class="close-btn" aria-label="Close">&times;</button>
    <h2 id="modalTitle"></h2>
    <p class="meta" id="modalMeta"></p>
    <div class="description" id="modalDescription"></div>
    <a href="#" target="_blank" rel="noopener noreferrer" class="full-link" id="modalLink">Read full article</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const RSS_FEEDS = [
    { name: 'Reuters', url: 'https://feeds.reuters.com/Reuters/worldNews' },
    { name: 'BBC', url: 'https://feeds.bbci.co.uk/news/world/rss.xml' },
    { name: 'AP', url: 'https://rss.apnews.com/AP-Top-News' },
    { name: 'Al Jazeera', url: 'https://www.aljazeera.com/xml/rss/all.xml' },
    { name: 'NPR', url: 'https://feeds.npr.org/1001/rss.xml' }
  ];
  const LOCAL_RSS_FEEDS = {
    'IN': [
      { name: 'Times of India', url: 'https://timesofindia.indiatimes.com/rssfeedstopstories.cms' },
      { name: 'The Hindu', url: 'https://www.thehindu.com/news/national/feeder/default.rss' }
    ],
    'US': [
      { name: 'NYT', url: 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml' },
      { name: 'WSJ', url: 'https://feeds.a.dj.com/rss/RSSWorldNews.xml' }
    ]
  };
  const RSS_PROXY = 'https://api.allorigins.win/get?url=';
  const THEMES = [
    { name: 'Serene Dawn', class: 'theme-0' },
    { name: 'Midnight Matrix', class: 'theme-1' },
    { name: 'Retro Terminal', class: 'theme-2' },
    { name: 'Sahara Sunset', class: 'theme-3' },
    { name: 'Synthwave Grid', class: 'theme-4' }
  ];
  const CHAOS_LEVELS = ['Tranquil ‚ú®', 'Slightly Odd ü§î', 'Moderately Spicy üå∂Ô∏è', 'Quite Dramatic üé≠', 'Peak Weirdness üå™Ô∏è'];
  const MARKET_TICKERS = [
    { name: 'Dow Jones', value: 38850.21, change: 0 },
    { name: 'Nikkei 225', value: 39210.87, change: 0 },
    { name: 'FTSE 100', value: 8247.11, change: 0 }
  ];

  // DOM Elements
  const newsFeedEl = document.getElementById('newsFeed');
  const localNewsFeedEl = document.getElementById('localNewsFeed');
  const newsStatusIndicatorEl = document.getElementById('newsStatusIndicator');
  const newsStatusTextEl = document.getElementById('newsStatusText');
  const lastUpdateEl = document.getElementById('lastUpdate');
  const chaosLevelEl = document.getElementById('chaosLevel');
  const marketDataEl = document.getElementById('marketData');
  const weatherDataEl = document.getElementById('weatherData');
  const localIntelEl = document.getElementById('localIntel');
  const themeSwitcherEl = document.getElementById('themeSwitcher');
  const notificationEl = document.getElementById('customNotification');

  // Modal Elements
  const modal = document.getElementById('newsModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalMeta = document.getElementById('modalMeta');
  const modalDescription = document.getElementById('modalDescription');
  const modalLink = document.getElementById('modalLink');
  const closeModalBtn = modal.querySelector('button.close-btn');

  let currentChaosIndex = 0;

  // Apply theme on <html> element and save preference
  function applyTheme(themeClass) {
    // Remove all known theme classes
    THEMES.forEach(t => document.documentElement.classList.remove(t.class));
    document.documentElement.classList.add(themeClass);
    localStorage.setItem('preferredTheme', themeClass);
  }

  // Initialize theme, setting from localStorage or by day index fallback
  function initializeTheme() {
    const preferredTheme = localStorage.getItem('preferredTheme');
    if (preferredTheme && THEMES.some(t => t.class === preferredTheme)) {
      applyTheme(preferredTheme);
    } else {
      const dayIndex = new Date().getDay() % THEMES.length;
      applyTheme(THEMES[dayIndex].class);
    }
    // Render buttons
    THEMES.forEach(theme => {
      const button = document.createElement('button');
      button.textContent = theme.name;
      button.className = 'py-1 px-3 rounded-md text-sm border transition-all';
      button.style.borderColor = 'var(--border-color)';
      button.onclick = () => {
        applyTheme(theme.class);
        showNotification(`Theme changed to ${theme.name}`);
      };
      themeSwitcherEl.appendChild(button);
    });
  }

  // Show notification
  function showNotification(message) {
    notificationEl.textContent = message;
    notificationEl.classList.add('show');
    setTimeout(() => {
      notificationEl.classList.remove('show');
    }, 3000);
  }

  // Location logic
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(locationSuccess, locationError);
    } else {
      handleLocationError("Geolocation is not supported by this browser.");
    }
  }
  async function locationSuccess(position) {
    const { latitude, longitude } = position.coords;
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
      if (!response.ok) throw new Error('Reverse geocoding failed');
      const data = await response.json();

      const countryCode = data.address.country_code.toUpperCase();
      const cityName = data.address.city || data.address.town || data.address.village || 'Unknown Area';
      updateLocalIntel(cityName, latitude, longitude);
      updateWeatherForLocation(cityName, latitude, longitude);
      fetchLocalNews(countryCode);
    } catch (error) {
      console.error("Reverse geocoding error:", error);
      const countryCode = 'IN';
      const cityName = 'Bengaluru (Fallback)';
      updateLocalIntel(cityName, latitude, longitude);
      updateWeatherForLocation(cityName, latitude, longitude);
      fetchLocalNews(countryCode);
    }
  }
  function locationError(error) {
    let message = "Could not determine location.";
    switch(error.code) {
      case error.PERMISSION_DENIED: message = "Location access denied by user."; break;
      case error.POSITION_UNAVAILABLE: message = "Location information is unavailable."; break;
      case error.TIMEOUT: message = "The request to get user location timed out."; break;
    }
    handleLocationError(message);
  }
  function handleLocationError(message) {
    showNotification(message);
    localIntelEl.innerHTML = `<p class="text-sm" style="color: var(--muted-text);">${message}</p>`;
    weatherDataEl.innerHTML = `<p class="text-sm" style="color: var(--muted-text);">${message}</p>`;
    localNewsFeedEl.innerHTML = `<p class="text-sm" style="color: var(--muted-text);">${message}</p>`;
  }

  // News fetch and display

  async function fetchAndDisplayNews(feeds, element, itemCount) {
    element.innerHTML = '<div class="space-y-3"><div class="h-16 rounded-lg skeleton"></div><div class="h-16 rounded-lg skeleton"></div></div>';
    const promises = feeds.map(feed =>
      fetch(`${RSS_PROXY}${encodeURIComponent(feed.url)}`)
        .then(response => response.ok ? response.json() : Promise.reject(`Failed fetch for ${feed.name}`))
        .then(data => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(data.contents, "text/xml");
          const items = Array.from(xmlDoc.querySelectorAll("item")).slice(0, itemCount);
          return items.map(item => ({
            title: item.querySelector('title')?.textContent || 'No title',
            link: item.querySelector('link')?.textContent || '#',
            pubDate: new Date(item.querySelector('pubDate')?.textContent || Date.now()),
            description: item.querySelector("description")?.textContent
                         || item.querySelector("content\\:encoded")?.textContent
                         || "No description available.",
            source: feed.name
          }));
        }).catch(error => {
            console.warn(`Failed to fetch ${feed.name}:`, error);
            return [];
        })
    );
    try {
      const results = await Promise.all(promises);
      const allNews = results.flat().sort((a,b) => b.pubDate - a.pubDate);

      if (allNews.length > 0) {
        displayNews(allNews, element);
        return allNews.length;
      } else {
        throw new Error("All news feeds failed for this category.");
      }
    } catch (error) {
      element.innerHTML = `<p class="text-sm p-4 text-center" style="color: var(--muted-text);">${error.message}<br>The CORS proxy might be temporarily down.</p>`;
      return 0;
    }
  }
  async function fetchGlobalNews() {
    const count = await fetchAndDisplayNews(RSS_FEEDS, newsFeedEl, 15);
    newsStatusTextEl.textContent = `Live - ${count} articles loaded.`;
    newsStatusIndicatorEl.className = `w-3 h-3 rounded-full ${count > 0 ? 'bg-green-500' : 'bg-red-500'}`;
  }
  async function fetchLocalNews(countryCode) {
    const localFeeds = LOCAL_RSS_FEEDS[countryCode];
    if (localFeeds) {
      await fetchAndDisplayNews(localFeeds, localNewsFeedEl, 15);
    } else {
      localNewsFeedEl.innerHTML = `<p class="text-sm p-4 text-center" style="color: var(--muted-text);">No local news feeds configured for your region (${countryCode}).</p>`;
    }
  }

  // Display news and modal popup logic
  function displayNews(newsItems, element) {
    element.innerHTML = '';
    newsItems.forEach(item => {
      const timeAgo = getTimeAgo(item.pubDate);

      const card = document.createElement('div');
      card.className = 'block p-3 rounded-lg transition-colors cursor-pointer';
      card.style.border = '1px solid transparent';
      card.onmouseover = () => card.style.backgroundColor = 'rgba(128,128,128,0.1)';
      card.onmouseout = () => card.style.backgroundColor = 'transparent';

      card.innerHTML = `
        <h3 class="font-bold leading-tight">${escapeHtml(item.title)}</h3>
        <p class="text-xs mt-1" style="color: var(--muted-text);">${item.source} ‚Ä¢ ${timeAgo}</p>
      `;

      card.addEventListener('click', () => {
        modalTitle.textContent = item.title;
        modalMeta.textContent = `${item.source} ‚Ä¢ ${timeAgo}`;
        modalDescription.innerHTML = item.description;
        modalLink.href = item.link;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      element.appendChild(card);
    });
  }

  // Close modal handlers
  closeModalBtn.addEventListener('click', () => {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  });
  modal.addEventListener('click', e => {
    if (e.target === modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // Other widgets
  function updateChaosLevel() {
    currentChaosIndex = (currentChaosIndex + 1) % CHAOS_LEVELS.length;
    chaosLevelEl.textContent = CHAOS_LEVELS[currentChaosIndex];
  }
  function updateMarkets() {
    marketDataEl.innerHTML = '';
    MARKET_TICKERS.forEach(ticker => {
      const change = (Math.random() - 0.5) * (ticker.value * 0.01);
      ticker.value += change;
      const isUp = change >= 0;
      const color = isUp ? '#22c55e' : '#ef4444';
      const sign = isUp ? '+' : '';
      const arrow = isUp ? '‚ñ≤' : '‚ñº';
      const el = document.createElement('div');
      el.className = 'flex justify-between items-center text-sm';
      el.innerHTML = `
        <div>
          <p class="font-bold">${ticker.name}</p>
          <p class="font-mono text-xs">${ticker.value.toFixed(2)}</p>
        </div>
        <div class="text-right font-mono font-bold" style="color: ${color};">
          <span>${arrow} ${sign}${change.toFixed(2)}</span>
          <span class="block text-xs">(${(change / ticker.value * 100).toFixed(2)}%)</span>
        </div>
      `;
      marketDataEl.appendChild(el);
    });
  }
  async function updateWeatherForLocation(cityName, lat, lon) {
    try {
      const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      if (!response.ok) throw new Error('Weather API failed');
      const data = await response.json();
      const weather = data.current_weather;
      const temp = weather.temperature;
      const condition = getWeatherCondition(weather.weathercode);
      weatherDataEl.innerHTML = `
        <div class="text-center">
          <p class="text-lg font-bold">${cityName}</p>
          <p class="text-5xl my-2">${condition.icon}</p>
          <p class="text-2xl font-bold font-mono">${temp}¬∞C</p>
          <p style="color: var(--muted-text);">${condition.text}</p>
        </div>
      `;
    } catch (error) {
      console.error("Weather fetch error:", error);
      weatherDataEl.innerHTML = `<p class="text-sm text-center" style="color: var(--muted-text);">Could not fetch live weather data.</p>`;
    }
  }
  function getWeatherCondition(code) {
    if (code === 0) return { icon: '‚òÄÔ∏è', text: 'Clear sky' };
    if (code <= 3) return { icon: '‚õÖ', text: 'Partly cloudy' };
    if (code <= 48) return { icon: 'üå´Ô∏è', text: 'Fog' };
    if (code <= 55) return { icon: 'üåßÔ∏è', text: 'Drizzle' };
    if (code <= 65) return { icon: 'üåßÔ∏è', text: 'Rain' };
    if (code <= 75) return { icon: '‚ùÑÔ∏è', text: 'Snowfall' };
    if (code <= 82) return { icon: '‚õàÔ∏è', text: 'Rain showers' };
    if (code <= 99) return { icon: '‚õàÔ∏è', text: 'Thunderstorm' };
    return { icon: 'üåç', text: 'Unknown' };
  }
  function updateLocalIntel(cityName, lat, lon) {
    localIntelEl.innerHTML = `
      <h3 class="font-bold text-sm uppercase tracking-wider" style="color: var(--muted-text);">Local Intel</h3>
      <div class="flex justify-between items-center text-sm">
        <span class="font-semibold">City:</span>
        <span class="font-bold">${cityName}</span>
      </div>
      <div class="flex justify-between items-center text-sm">
        <span class="font-semibold">Coords:</span>
        <span class="font-mono">${lat.toFixed(2)}, ${lon.toFixed(2)}</span>
      </div>
    `;
  }

  function updateLastRefreshTime() {
    lastUpdateEl.textContent = new Date().toLocaleTimeString();
  }
  function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.round(diffMs / 60000);
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    const diffHours = Math.round(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    const diffDays = Math.round(diffHours / 24);
    return `${diffDays}d ago`;
  }
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "'");
  }

  // Initialize dashboard
  function initializeDashboard() {
    initializeTheme();
    getLocation();
    fetchGlobalNews();
    updateMarkets();
    updateChaosLevel();
    updateLastRefreshTime();

    setInterval(fetchGlobalNews, 5 * 60 * 1000);
    setInterval(updateMarkets, 5000);
    setInterval(updateChaosLevel, 6000);
    setInterval(updateLastRefreshTime, 60 * 1000);
  }
  initializeDashboard();
});
</script>
</body>
</html>
